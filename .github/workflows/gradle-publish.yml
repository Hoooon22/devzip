name: dev branch auto ci process script

on:
  push:
    branches: [ master ]

jobs:
  checkout:
    name: ğŸ“ Checkout Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

  stop_services:
    name: ğŸ›‘ Stop Existing Services
    runs-on: ubuntu-latest
    needs: checkout  # checkout job ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      - name: Connect & Stop Services
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: |
            echo "ğŸ”— Navigating to project directory"
            cd /var/project/devzip/
            echo "ğŸ›‘ Stopping running services"
            ./gradlew --stop
            fuser -k 8080/tcp || echo "âš ï¸ No process running on port 8080"
            pm2 stop all || echo "âš ï¸ No PM2 processes running"
            pm2 delete all || echo "âš ï¸ No PM2 processes to delete"
            echo "âœ… Services stopped"

  build:
    name: ğŸ—ï¸ Clean & Build Project
    runs-on: ubuntu-latest
    needs: stop_services  # stop_services ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      - name: Connect & Build Project
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: |
            echo "ğŸ§¹ Cleaning previous build"
            cd /var/project/devzip/
            sudo rm -rf build/
            sudo yum clean all
            echo "ğŸ“¥ Pulling latest code"
            git pull origin master || { echo "âŒ Git pull failed"; exit 1; }
            echo "ğŸ—ï¸ Building project"
            ./gradlew clean build --no-daemon --parallel --configure-on-demand || { echo "âŒ Build failed"; exit 1; }
            echo "âœ… Build completed"

  deploy:
    name: ğŸš€ Deploy & Restart Services
    runs-on: ubuntu-latest
    needs: build  # build ì™„ë£Œ í›„ ì‹¤í–‰

    steps:
      - name: Restart PM2 services
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: |
            echo "ğŸš€ Deploying application"
            cd /var/project/devzip/
            
            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x src/main/resources/update_trends.sh
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p logs
            
            # ì„œë²„ ì‹œì‘ ì‹œ ë°”ë¡œ íŠ¸ë Œë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜í–‰
            echo "ğŸ”„ Initial trend data update"
            src/main/resources/update_trends.sh >> logs/trend_update.log 2>&1 || echo "âš ï¸ Trend data update failed but continuing"
            
            # ì„œë²„ ì‹œì‘
            echo "ğŸš€ Starting main server"
            pm2 start server.json || { echo "âŒ Failed to start server"; exit 1; }
            
            # PM2ë¡œ 2ì‹œê°„ë§ˆë‹¤ íŠ¸ë Œë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„¤ì •
            echo "â±ï¸ Setting up scheduled trend updates"
            pm2 start --name "trend-updater" --cron "0 */2 * * *" src/main/resources/update_trends.sh || { echo "âš ï¸ Failed to schedule trend updates but continuing"; }
            
            # ê°€ìƒ í™˜ê²½ ì„¤ì • ë° Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "ğŸ Setting up Python environment"
            python3 -m venv venv || echo "âš ï¸ Virtual environment creation failed but continuing"
            source venv/bin/activate
            pip install --no-cache-dir pytrends || echo "âš ï¸ Failed to install Python packages but continuing"
            deactivate
            
            # PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ í™•ì¸
            echo "ğŸ“‹ Current PM2 processes:"
            pm2 list
            
            echo "âœ… Deployment and service restart completed"
            echo "ğŸ”— ì„œë¹„ìŠ¤ URL: https://devzip.site"
