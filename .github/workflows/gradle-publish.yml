name: dev branch auto ci process script

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Connect to EC2 via SSH and deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: |
            echo "::group::ğŸ”— Change directory to project"
            cd /var/project/devzip/
            echo "âœ… Directory changed"
            echo "::endgroup::"

            echo "::group::ğŸ›‘ Stop running services"
            ./gradlew --stop
            fuser -k 8080/tcp || echo "âš ï¸ No process running on port 8080"
            pm2 stop all || echo "âš ï¸ No PM2 processes running"
            pm2 delete all || echo "âš ï¸ No PM2 processes to delete"
            echo "âœ… Services stopped"
            echo "::endgroup::"

            echo "::group::ğŸ§¹ Clean build folder and cache"
            sudo rm -rf build/
            sudo yum clean all
            echo "âœ… Build folder cleaned"
            echo "::endgroup::"

            echo "::group::ğŸ“¥ Pull latest code from master"
            git pull origin master || { echo "âŒ Git pull failed"; exit 1; }
            echo "âœ… Code pulled successfully"
            echo "::endgroup::"

            echo "::group::ğŸ—ï¸ Build project with Gradle"
            ./gradlew clean build --no-daemon --parallel --configure-on-demand || { echo "âŒ Build failed"; exit 1; }
            echo "âœ… Build completed"
            echo "::endgroup::"

            echo "::group::ğŸš€ Restart PM2 processes"
            pm2 start server.json || { echo "âŒ Failed to start server"; exit 1; }
            pm2 start src/main/python/trends.py --cron "0 */2 * * *" --no-autorestart || { echo "âŒ Failed to start Python process"; exit 1; }
            echo "âœ… PM2 processes restarted"
            echo "::endgroup::"
