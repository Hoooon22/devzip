name: DevZip CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'  # package.jsonÍ≥º ÏùºÏπò

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      deployments: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Set up Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/main/frontend/package-lock.json

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build Application
      env:
        CI: false
        GENERATE_SOURCEMAP: false
      run: |
        chmod +x gradlew
        ./gradlew build -x test

        # JAR ÌååÏùº ÌôïÏù∏
        ls -lh build/libs/
        echo "‚úÖ Build completed"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Docker image
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
        IMAGE_REPO="ghcr.io/${OWNER_LC}/devzip"
        docker buildx build \
          --platform linux/amd64 \
          -t "${IMAGE_REPO}:${IMAGE_TAG}" \
          -t "${IMAGE_REPO}:latest" \
          --push .
        echo "IMAGE_REPO=${IMAGE_REPO}" >> $GITHUB_ENV
        echo "IMAGE_FULL=${IMAGE_REPO}:${IMAGE_TAG}" >> $GITHUB_ENV
        echo "‚úÖ Image pushed: ${IMAGE_REPO}:${IMAGE_TAG}"

    - name: Build & Deploy on Production Server
      uses: appleboy/ssh-action@v1.0.3
      env:
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_SHA: ${{ github.sha }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        timeout: 60s
        command_timeout: 10m
        envs: GHCR_TOKEN,GITHUB_REPOSITORY_OWNER,GITHUB_SHA
        script: |
          cd /home/ubuntu/project/devzip
          echo "üöÄ Starting deployment (pulling prebuilt image)..."

          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_REPO="ghcr.io/${OWNER_LC}/devzip"
          IMAGE_TAG="${GITHUB_SHA}"
          IMAGE_FULL="${IMAGE_REPO}:${IMAGE_TAG}"

          # Git Ï†ÄÏû•ÏÜå ÏµúÏã†Ìôî
          echo "üì• Updating git repository..."
          git config pull.rebase false
          git pull origin master
          echo "‚úÖ Git repository updated"

          # Ïª®ÌÖåÏù¥ÎÑà Î†àÏßÄÏä§Ìä∏Î¶¨ Î°úÍ∑∏Ïù∏ (GHCR)
          echo "üîë Logging into GHCR..."
          echo "${GHCR_TOKEN}" | sudo docker login ghcr.io -u "${GITHUB_REPOSITORY_OWNER}" --password-stdin

          # ÏµúÏã† Ïù¥ÎØ∏ÏßÄ ÌíÄ Î∞è Ïª®ÌÖåÏù¥ÎÑà ÍµêÏ≤¥
          echo "üê≥ Pulling image ${IMAGE_FULL}..."
          APP_IMAGE="${IMAGE_FULL}" sudo -E docker compose pull app

          echo "üöÄ Recreating containers with new image..."
          APP_IMAGE="${IMAGE_FULL}" sudo -E docker compose up -d --force-recreate app

          echo "‚è≥ Waiting briefly for application to start..."
          sleep 10

          # Ìó¨Ïä§Ï≤¥ÌÅ¨
          for i in {1..12}; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ Application started successfully!"
              exit 0
            fi
            echo "‚è≥ Waiting... ($i/12)"
            sleep 3
          done

          echo "‚ö†Ô∏è Application might be starting slower than expected"
          echo "üéâ Deployment completed!"

  health-check:
    name: Health Check & Verification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-health-check]')

    steps:
    - name: Wait for Application Startup
      run: |
        echo "‚è≥ Waiting briefly for application to fully start..."
        echo "üìä Docker start-period is 60s, waiting adequately..."
        sleep 45

    - name: Health Check - Server Local (authoritative)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        timeout: 60s
        command_timeout: 2m
        script: |
          echo "üè• Checking app health from server..."
          max_retries=10
          wait_time=6
          for i in $(seq 1 $max_retries); do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
            if [ "$status" = "200" ]; then
              echo "‚úÖ Local health check passed (attempt ${i}/${max_retries})"
              exit 0
            fi
            echo "‚è≥ Local health check failed (HTTP $status), retrying in ${wait_time}s... (attempt ${i}/${max_retries})"
            sleep $wait_time
          done
          echo "‚ùå Local health check failed after $max_retries attempts"
          exit 1

    - name: Health Check - External (informational)
      run: |
        echo "üåê Running external health check (non-blocking, informational)..."
        response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://devzip.cloud/actuator/health || echo "000")
        echo "‚ÑπÔ∏è  External status: $response"
        if [ "$response" != "200" ]; then
          echo "‚ö†Ô∏è External check did not return 200. This may be due to firewall or DNS restrictions from GitHub runners."
        else
          echo "‚úÖ External endpoint reachable."
        fi

    - name: Authentication System Check
      run: |
        echo "üîê Testing JWT authentication system..."

        login_response=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://devzip.cloud/api/auth/signin \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}' || echo "000")

        if [ "$login_response" = "403" ] || [ "$login_response" = "401" ] || [ "$login_response" = "400" ]; then
          echo "‚úÖ Authentication endpoint: Responding properly"
        elif [ "$login_response" = "404" ]; then
          echo "‚ùå Authentication endpoint: Not found"
        else
          echo "‚ö†Ô∏è Authentication endpoint: Unexpected response ($login_response)"
        fi

    - name: Frontend Loading Check
      run: |
        echo "üåê Testing frontend loading..."

        main_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/ || echo "000")

        if [ "$main_response" = "200" ]; then
          echo "‚úÖ Main page: Loading successfully"
        else
          echo "‚ùå Main page: Failed to load (HTTP $main_response)"
        fi

    - name: Protected Routes Check
      run: |
        echo "üõ°Ô∏è Testing protected routes..."

        dashboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/dashboard || echo "000")
        traceboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/traceboard || echo "000")

        if [ "$dashboard_response" = "200" ] || [ "$dashboard_response" = "302" ] || [ "$dashboard_response" = "401" ]; then
          echo "‚úÖ Dashboard protection: Working"
        else
          echo "‚ö†Ô∏è Dashboard protection: Unexpected response ($dashboard_response)"
        fi

        if [ "$traceboard_response" = "200" ] || [ "$traceboard_response" = "302" ] || [ "$traceboard_response" = "401" ]; then
          echo "‚úÖ Traceboard protection: Working"
        else
          echo "‚ö†Ô∏è Traceboard protection: Unexpected response ($traceboard_response)"
        fi

    - name: Final Status Report
      run: |
        echo ""
        echo "üìä Deployment Status Summary:"
        echo "=========================================="
        echo "üéØ Application: DevZip"
        echo "üåê URL: https://devzip.cloud"
        echo "üîê Authentication: JWT-based admin system"
        echo "üõ°Ô∏è Protected Routes: Dashboard, Traceboard"
        echo "‚ö° Features: Real-time analytics, User tracking"
        echo ""
        echo "‚úÖ Deployment completed successfully!"
        echo "üöÄ All systems operational and ready for use!"

    - name: Send Success Webhook
      if: success()
      run: |
        curl -k -X POST https://devzip.cloud/api/webhook/github-actions \
          -H "Content-Type: application/json" \
          -d '{
            "workflow_name": "${{ github.workflow }}",
            "status": "success",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "author": "${{ github.actor }}",
            "run_number": "${{ github.run_number }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S)'",
            "environment": "production"
          }' || echo "‚ö†Ô∏è Webhook notification failed (non-blocking)"

    - name: Send Failure Webhook
      if: failure()
      run: |
        curl -k -X POST https://devzip.cloud/api/webhook/github-actions \
          -H "Content-Type: application/json" \
          -d '{
            "workflow_name": "${{ github.workflow }}",
            "status": "failure",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "author": "${{ github.actor }}",
            "run_number": "${{ github.run_number }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "failed_job": "${{ github.job }}",
            "failure_reason": "Health check or deployment verification failed",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S)'",
            "environment": "production"
          }' || echo "‚ö†Ô∏è Webhook notification failed (non-blocking)"
