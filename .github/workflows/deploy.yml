name: DevZip CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'  # package.jsonê³¼ ì¼ì¹˜

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      deployments: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Set up Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/main/frontend/package-lock.json

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build Application
      env:
        CI: false
        GENERATE_SOURCEMAP: false
      run: |
        chmod +x gradlew
        ./gradlew build -x test

        # JAR íŒŒì¼ í™•ì¸
        ls -lh build/libs/
        echo "âœ… Build completed"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Docker image
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
        IMAGE_REPO="ghcr.io/${OWNER_LC}/devzip"
        docker buildx build \
          --platform linux/amd64 \
          -t "${IMAGE_REPO}:${IMAGE_TAG}" \
          -t "${IMAGE_REPO}:latest" \
          --push .
        echo "IMAGE_REPO=${IMAGE_REPO}" >> $GITHUB_ENV
        echo "IMAGE_FULL=${IMAGE_REPO}:${IMAGE_TAG}" >> $GITHUB_ENV
        echo "âœ… Image pushed: ${IMAGE_REPO}:${IMAGE_TAG}"

    - name: Build & Deploy on Production Server
      uses: appleboy/ssh-action@v1.0.3
      env:
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_SHA: ${{ github.sha }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        timeout: 60s
        command_timeout: 10m
        envs: GHCR_TOKEN,GITHUB_REPOSITORY_OWNER,GITHUB_SHA
        script: |
          cd /home/ubuntu/project/devzip
          echo "ğŸš€ Starting deployment (pulling prebuilt image)..."

          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_REPO="ghcr.io/${OWNER_LC}/devzip"
          IMAGE_TAG="${GITHUB_SHA}"
          IMAGE_FULL="${IMAGE_REPO}:${IMAGE_TAG}"

          # Git ì €ì¥ì†Œ ìµœì‹ í™”
          echo "ğŸ“¥ Updating git repository..."
          git config pull.rebase false
          git pull origin master
          echo "âœ… Git repository updated"

          # ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ (GHCR)
          echo "ğŸ”‘ Logging into GHCR..."
          echo "${GHCR_TOKEN}" | sudo docker login ghcr.io -u "${GITHUB_REPOSITORY_OWNER}" --password-stdin

          # ìµœì‹  ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ êµì²´
          echo "ğŸ³ Pulling image ${IMAGE_FULL}..."
          APP_IMAGE="${IMAGE_FULL}" sudo -E docker compose pull app

          echo "ğŸš€ Recreating containers with new image..."
          APP_IMAGE="${IMAGE_FULL}" sudo -E docker compose up -d --force-recreate app

          echo "â³ Waiting for application to start (increased wait time due to fresh build)..."
          sleep 30

          # í—¬ìŠ¤ì²´í¬
          for i in {1..12}; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Application started successfully!"
              exit 0
            fi
            echo "â³ Waiting... ($i/12)"
            sleep 3
          done

          echo "âš ï¸ Application might be starting slower than expected"
          echo "ğŸ‰ Deployment completed!"

  health-check:
    name: Health Check & Verification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-health-check]')

    steps:
    - name: Wait for Application Startup
      run: |
        echo "â³ Waiting for application to fully start..."
        echo "ğŸ“Š Docker start-period is 180s, waiting sufficiently..."
        sleep 90

    - name: Health Check - Basic Connectivity
      run: |
        echo "ğŸ¥ Running health checks with retry logic..."

        max_retries=10
        retry_count=0
        wait_time=10

        while [ $retry_count -lt $max_retries ]; do
          body_file=$(mktemp)
          response=$(curl -s -o "$body_file" -w "%{http_code}" https://devzip.cloud/actuator/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Health check endpoint: OK (attempt $((retry_count + 1))/$max_retries)"
            rm -f "$body_file"
            break
          else
            echo "â„¹ï¸  Status: $response"
            echo "â„¹ï¸  Body:"
            cat "$body_file"
            rm -f "$body_file"
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Health check failed (HTTP $response), retrying in ${wait_time}s... (attempt $retry_count/$max_retries)"
              sleep $wait_time
            else
              echo "âŒ Health check endpoint failed after $max_retries attempts (HTTP $response)"
              exit 1
            fi
          fi
        done

    - name: Authentication System Check
      run: |
        echo "ğŸ” Testing JWT authentication system..."

        login_response=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://devzip.cloud/api/auth/signin \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}' || echo "000")

        if [ "$login_response" = "403" ] || [ "$login_response" = "401" ] || [ "$login_response" = "400" ]; then
          echo "âœ… Authentication endpoint: Responding properly"
        elif [ "$login_response" = "404" ]; then
          echo "âŒ Authentication endpoint: Not found"
        else
          echo "âš ï¸ Authentication endpoint: Unexpected response ($login_response)"
        fi

    - name: Frontend Loading Check
      run: |
        echo "ğŸŒ Testing frontend loading..."

        main_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/ || echo "000")

        if [ "$main_response" = "200" ]; then
          echo "âœ… Main page: Loading successfully"
        else
          echo "âŒ Main page: Failed to load (HTTP $main_response)"
        fi

    - name: Protected Routes Check
      run: |
        echo "ğŸ›¡ï¸ Testing protected routes..."

        dashboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/dashboard || echo "000")
        traceboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/traceboard || echo "000")

        if [ "$dashboard_response" = "200" ] || [ "$dashboard_response" = "302" ] || [ "$dashboard_response" = "401" ]; then
          echo "âœ… Dashboard protection: Working"
        else
          echo "âš ï¸ Dashboard protection: Unexpected response ($dashboard_response)"
        fi

        if [ "$traceboard_response" = "200" ] || [ "$traceboard_response" = "302" ] || [ "$traceboard_response" = "401" ]; then
          echo "âœ… Traceboard protection: Working"
        else
          echo "âš ï¸ Traceboard protection: Unexpected response ($traceboard_response)"
        fi

    - name: Final Status Report
      run: |
        echo ""
        echo "ğŸ“Š Deployment Status Summary:"
        echo "=========================================="
        echo "ğŸ¯ Application: DevZip"
        echo "ğŸŒ URL: https://devzip.cloud"
        echo "ğŸ” Authentication: JWT-based admin system"
        echo "ğŸ›¡ï¸ Protected Routes: Dashboard, Traceboard"
        echo "âš¡ Features: Real-time analytics, User tracking"
        echo ""
        echo "âœ… Deployment completed successfully!"
        echo "ğŸš€ All systems operational and ready for use!"
