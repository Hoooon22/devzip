name: DevZip CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'  # package.jsonê³¼ ì¼ì¹˜

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Set up Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/main/frontend/package-lock.json

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build Application
      env:
        CI: false
        GENERATE_SOURCEMAP: false
      run: |
        chmod +x gradlew
        ./gradlew clean build -x test

        # JAR íŒŒì¼ í™•ì¸
        ls -lh build/libs/
        echo "âœ… Build completed"

    - name: Deploy to Production Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "build/libs/*.jar"
        target: "/home/ubuntu/project/devzip/"
        strip_components: 2
        timeout: 5m

    - name: Restart Docker Services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        timeout: 60s
        command_timeout: 10m
        script: |
          cd /home/ubuntu/project/devzip
          echo "ğŸš€ Starting deployment..."

          # Git ì €ì¥ì†Œ ìµœì‹ í™”
          echo "ğŸ“¥ Updating git repository..."
          git config pull.rebase false
          git pull origin master
          echo "âœ… Git repository updated"

          # JAR íŒŒì¼ í™•ì¸
          if [ ! -f build/libs/*.jar ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi

          echo "âœ… JAR file verified"
          ls -lh build/libs/

          # Docker ì¬ì‹œì‘ (ë¹Œë“œ ìŠ¤í‚µ)
          echo "ğŸ³ Restarting Docker containers..."
          docker compose down
          docker compose up -d --build

          echo "â³ Waiting for application to start..."
          sleep 15

          # í—¬ìŠ¤ì²´í¬
          for i in {1..10}; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Application started successfully!"
              exit 0
            fi
            echo "â³ Waiting... ($i/10)"
            sleep 3
          done

          echo "âš ï¸ Application might be starting slower than expected"
          echo "ğŸ‰ Deployment completed!"

  health-check:
    name: Health Check & Verification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-health-check]')

    steps:
    - name: Wait for Application Startup
      run: |
        echo "â³ Waiting for application to fully start..."
        sleep 30

    - name: Health Check - Basic Connectivity
      run: |
        echo "ğŸ¥ Running health checks..."

        response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/actuator/health || echo "000")

        if [ "$response" = "200" ]; then
          echo "âœ… Health check endpoint: OK"
        else
          echo "âŒ Health check endpoint failed (HTTP $response)"
          exit 1
        fi

    - name: Authentication System Check
      run: |
        echo "ğŸ” Testing JWT authentication system..."

        login_response=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://devzip.cloud/api/auth/signin \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}' || echo "000")

        if [ "$login_response" = "403" ] || [ "$login_response" = "401" ] || [ "$login_response" = "400" ]; then
          echo "âœ… Authentication endpoint: Responding properly"
        elif [ "$login_response" = "404" ]; then
          echo "âŒ Authentication endpoint: Not found"
        else
          echo "âš ï¸ Authentication endpoint: Unexpected response ($login_response)"
        fi

    - name: Frontend Loading Check
      run: |
        echo "ğŸŒ Testing frontend loading..."

        main_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/ || echo "000")

        if [ "$main_response" = "200" ]; then
          echo "âœ… Main page: Loading successfully"
        else
          echo "âŒ Main page: Failed to load (HTTP $main_response)"
        fi

    - name: Protected Routes Check
      run: |
        echo "ğŸ›¡ï¸ Testing protected routes..."

        dashboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/dashboard || echo "000")
        traceboard_response=$(curl -s -o /dev/null -w "%{http_code}" https://devzip.cloud/traceboard || echo "000")

        if [ "$dashboard_response" = "200" ] || [ "$dashboard_response" = "302" ] || [ "$dashboard_response" = "401" ]; then
          echo "âœ… Dashboard protection: Working"
        else
          echo "âš ï¸ Dashboard protection: Unexpected response ($dashboard_response)"
        fi

        if [ "$traceboard_response" = "200" ] || [ "$traceboard_response" = "302" ] || [ "$traceboard_response" = "401" ]; then
          echo "âœ… Traceboard protection: Working"
        else
          echo "âš ï¸ Traceboard protection: Unexpected response ($traceboard_response)"
        fi

    - name: Final Status Report
      run: |
        echo ""
        echo "ğŸ“Š Deployment Status Summary:"
        echo "=========================================="
        echo "ğŸ¯ Application: DevZip"
        echo "ğŸŒ URL: https://devzip.cloud"
        echo "ğŸ” Authentication: JWT-based admin system"
        echo "ğŸ›¡ï¸ Protected Routes: Dashboard, Traceboard"
        echo "âš¡ Features: Real-time analytics, User tracking"
        echo ""
        echo "âœ… Deployment completed successfully!"
        echo "ğŸš€ All systems operational and ready for use!"
